<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>شطرنج المحترفين - نسخة مستقرة</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        :root { --light: #f0d9b5; --dark: #b58863; --highlight: rgba(34, 139, 34, 0.6); }
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 10px; overflow: hidden; touch-action: manipulation; }
        
        /* تصميم اللوحة */
        #board-container { width: 95vw; max-width: 400px; margin: 10px auto; position: relative; }
        .board { display: grid; grid-template-columns: repeat(8, 1fr); border: 2px solid #333; user-select: none; }
        .square { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .square.light { background: var(--light); }
        .square.dark { background: var(--dark); }
        .square img { width: 90%; height: 90%; pointer-events: none; }
        
        /* تلميحات الحركة */
        .hint::after { content: ""; width: 30%; height: 30%; background: var(--highlight); border-radius: 50%; position: absolute; }
        .selected { background: rgba(255, 255, 0, 0.5) !important; }

        .controls { background: #1e1e1e; padding: 15px; border-radius: 10px; width: 90vw; max-width: 400px; margin: 10px auto; box-sizing: border-box; }
        .status { margin-bottom: 10px; font-size: 1.2rem; color: #2ecc71; font-weight: bold; }
        button { background: #27ae60; color: white; border: none; padding: 10px; margin: 5px; border-radius: 5px; width: 45%; font-weight: bold; cursor: pointer; }
        
        /* شاشة نهاية اللعبة */
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center; }
        #overlay h1 { color: #ff4444; font-size: 3rem; margin: 0; }
    </style>
</head>
<body>

    <!-- أصوات الحركة -->
    <audio id="moveSound" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3"></audio>
    <audio id="captureSound" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3"></audio>

    <div id="overlay">
        <h1 id="overTitle">GAME OVER</h1>
        <p id="overDesc" style="font-size: 1.5rem;"></p>
        <button onclick="location.reload()" style="width: 200px;">لعب جديد</button>
    </div>

    <h3>شطرنج المحترفين</h3>
    <div id="board-container">
        <div id="board" class="board"></div>
    </div>

    <div class="controls">
        <div id="status" class="status">الدور على: الأبيض</div>
        <button onclick="location.reload()">جيم جديد</button>
        <button onclick="toggleAI()" id="aiBtn">الوضع: ضد الكمبيوتر</button>
        <button onclick="changeLang()" id="langBtn" style="width: 95%">English</button>
    </div>

    <script>
        const game = new Chess();
        const boardEl = document.getElementById('board');
        let selectedSquare = null;
        let aiEnabled = true;
        let lang = 'ar';

        // روابط صور القطع
        const pieceImages = {
            'p': 'https://chessboardjs.com/img/chesspieces/wikipedia/bP.png',
            'r': 'https://chessboardjs.com/img/chesspieces/wikipedia/bR.png',
            'n': 'https://chessboardjs.com/img/chesspieces/wikipedia/bN.png',
            'b': 'https://chessboardjs.com/img/chesspieces/wikipedia/bB.png',
            'q': 'https://chessboardjs.com/img/chesspieces/wikipedia/bQ.png',
            'k': 'https://chessboardjs.com/img/chesspieces/wikipedia/bK.png',
            'P': 'https://chessboardjs.com/img/chesspieces/wikipedia/wP.png',
            'R': 'https://chessboardjs.com/img/chesspieces/wikipedia/wR.png',
            'N': 'https://chessboardjs.com/img/chesspieces/wikipedia/wN.png',
            'B': 'https://chessboardjs.com/img/chesspieces/wikipedia/wB.png',
            'Q': 'https://chessboardjs.com/img/chesspieces/wikipedia/wQ.png',
            'K': 'https://chessboardjs.com/img/chesspieces/wikipedia/wK.png'
        };

        function createBoard() {
            boardEl.innerHTML = '';
            for (let i = 0; i < 64; i++) {
                const row = Math.floor(i / 8);
                const col = i % 8;
                const squareName = String.fromCharCode(97 + col) + (8 - row);
                const square = document.createElement('div');
                square.classList.add('square');
                square.classList.add((row + col) % 2 === 0 ? 'light' : 'dark');
                square.dataset.square = squareName;
                square.onclick = () => handleSquareClick(squareName);
                boardEl.appendChild(square);
            }
            renderPieces();
        }

        function renderPieces() {
            const squares = document.querySelectorAll('.square');
            squares.forEach(sq => {
                sq.innerHTML = '';
                sq.classList.remove('hint', 'selected');
                const piece = game.get(sq.dataset.square);
                if (piece) {
                    const img = document.createElement('img');
                    img.src = pieceImages[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                    sq.appendChild(img);
                }
            });
        }

        function handleSquareClick(square) {
            if (game.game_over()) return;

            // إذا كان هناك تلميح، يعني هذا المربع هدف للحركة
            const hints = document.querySelectorAll('.hint');
            let isHint = false;
            hints.forEach(h => { if(h.dataset.square === square) isHint = true; });

            if (isHint) {
                executeMove(selectedSquare, square);
                return;
            }

            // اختيار قطعة
            const piece = game.get(square);
            if (piece && piece.color === game.turn()) {
                selectedSquare = square;
                renderPieces();
                document.querySelector(`[data-square="${square}"]`).classList.add('selected');
                const moves = game.moves({ square: square, verbose: true });
                moves.forEach(m => {
                    document.querySelector(`[data-square="${m.to}"]`).classList.add('hint');
                });
            } else {
                selectedSquare = null;
                renderPieces();
            }
        }

        function executeMove(from, to) {
            const move = game.move({ from, to, promotion: 'q' });
            if (move) {
                document.getElementById(move.captured ? 'captureSound' : 'moveSound').play();
                renderPieces();
                updateStatus();
                if (aiEnabled && !game.game_over()) {
                    setTimeout(makeBestMove, 600);
                }
            }
            selectedSquare = null;
        }

        // ذكاء اصطناعي متوسط القوة
        function makeBestMove() {
            const moves = game.moves();
            if (moves.length === 0) return;
            
            // ترتيب الحركات (الأولوية للأكل ثم الكش ثم العشوائي)
            moves.sort((a, b) => b.includes('x') - a.includes('x'));
            const bestMove = moves.find(m => m.includes('#')) || moves.find(m => m.includes('+')) || moves[0];
            
            const moveResult = game.move(bestMove);
            document.getElementById(moveResult.captured ? 'captureSound' : 'moveSound').play();
            renderPieces();
            updateStatus();
        }

        function updateStatus() {
            const turn = game.turn() === 'w' ? (lang === 'ar' ? 'الأبيض' : 'White') : (lang === 'ar' ? 'الأسود' : 'Black');
            document.getElementById('status').innerText = (lang === 'ar' ? 'دور: ' : 'Turn: ') + turn;

            if (game.game_over()) {
                document.getElementById('overlay').style.display = 'flex';
                let res = lang === 'ar' ? "انتهت اللعبة!" : "Game Over!";
                if (game.in_draw()) res = lang === 'ar' ? "تعادل!" : "Draw!";
                else res += (lang === 'ar' ? " فاز " : " Winner: ") + (game.turn() === 'w' ? (lang === 'ar' ? 'الأسود' : 'Black') : (lang === 'ar' ? 'الأبيض' : 'White'));
                document.getElementById('overDesc').innerText = res;
            }
        }

        function toggleAI() {
            aiEnabled = !aiEnabled;
            document.getElementById('aiBtn').innerText = aiEnabled ? 
                (lang === 'ar' ? 'الوضع: ضد الكمبيوتر' : 'Mode: vs AI') : 
                (lang === 'ar' ? 'الوضع: لاعبين' : 'Mode: 2 Players');
        }

        function changeLang() {
            lang = lang === 'ar' ? 'en' : 'ar';
            document.getElementById('langBtn').innerText = lang === 'ar' ? 'English' : 'العربية';
            updateStatus();
            toggleAI(); toggleAI();
        }

        // تشغيل اللعبة
        createBoard();
    </script>
</body>
</html>
