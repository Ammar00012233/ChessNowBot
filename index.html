<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zoge Chess</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<script src="https://unpkg.com/stockfish@16/stockfish.js"></script>

<style>
body { background:#121212; color:#fff; font-family:Arial; text-align:center }
#board { width:90vw; max-width:480px; margin:20px auto }
button { padding:15px 30px; font-size:18px; margin:10px; cursor:pointer }
#status { font-size:20px; margin:15px }
#loading { color:#ff0; display:none }
</style>
</head>

<body>

<h2>â™Ÿï¸ Ø´Ø·Ø±Ù†Ø¬ Ø¶Ø¯ AI Ù…Ø³ØªØ­ÙŠÙ„</h2>
<div id="loading">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙÙƒØ±...</div>
<div id="board"></div>
<div id="status">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡</div>

<button onclick="startGame('w')">Ø§Ù„Ø¹Ø¨ Ø£Ø¨ÙŠØ¶</button>
<button onclick="startGame('b')">Ø§Ù„Ø¹Ø¨ Ø£Ø³ÙˆØ¯</button>

<script>
let game = new Chess()
let board = null
let engine = null
let playerColor = 'w'
let engineReady = false

// ØªØ´ØºÙŠÙ„ Stockfish
function initEngine() {
  engine = new Worker("https://unpkg.com/stockfish@16/stockfish.js")

  engine.onmessage = (e) => {
    const line = e.data
    if (line === 'uciok') engineReady = true

    if (line.startsWith('bestmove')) {
      const move = line.split(' ')[1]
      game.move(move)
      board.position(game.fen())
      document.getElementById('loading').style.display = 'none'
      document.getElementById('status').textContent = 'Ø¯ÙˆØ±Ùƒ'
      if (game.game_over()) endGame()
    }
  }

  engine.postMessage('uci')
  engine.postMessage('setoption name Skill Level value 20')
  engine.postMessage('setoption name Hash value 256')
  engine.postMessage('setoption name Threads value 4')
  engine.postMessage('setoption name Contempt value 100')
}

function initBoard() {
  if (board) board.destroy()

  board = Chessboard('board', {
    draggable: true,
    position: game.fen(),
    orientation: playerColor === 'w' ? 'white' : 'black',

    onDragStart: (source) => {
      if (game.game_over()) return false
      if (game.turn() !== playerColor) return false
      if (game.turn() === 'w' && source[0] !== 'w') return false
      if (game.turn() === 'b' && source[0] !== 'b') return false
    },

    onDrop: (source, target) => {
      const move = game.move({ from: source, to: target, promotion: 'q' })
      if (!move) return 'snapback'

      if (game.game_over()) return endGame()

      document.getElementById('loading').style.display = 'block'
      document.getElementById('status').textContent = 'Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙÙƒØ±...'

      engine.postMessage('position fen ' + game.fen())
      engine.postMessage('go depth 40')
    }
  })
}

function startGame(color) {
  if (!engineReady) {
    alert('Ø§Ù„Ù€ AI Ù„Ù… ÙŠØ¬Ù‡Ø² Ø¨Ø¹Ø¯ØŒ Ø§Ù†ØªØ¸Ø± Ø«Ø§Ù†ÙŠØªÙŠÙ†')
    return
  }

  playerColor = color
  game.reset()
  initBoard()
  document.getElementById('status').textContent = 'Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©'

  if (playerColor === 'b') {
    document.getElementById('loading').style.display = 'block'
    engine.postMessage('position startpos')
    engine.postMessage('go depth 40')
  }
}

function endGame() {
  if (game.in_checkmate()) {
    document.getElementById('status').textContent =
      game.turn() === playerColor ? 'Ø®Ø³Ø±Øª ğŸ˜ˆ' : 'ÙØ²ØªØŸ Ù…Ø³ØªØ­ÙŠÙ„ ğŸ˜³'
  } else {
    document.getElementById('status').textContent = 'ØªØ¹Ø§Ø¯Ù„'
  }
}

initEngine()
</script>

</body>
</html>
