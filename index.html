<script>
  const game = new Chess();
  const engine = new Worker("stockfish.js");

  engine.postMessage("uci");
  engine.postMessage("isready");

  const board = Chessboard('board', {
    draggable: true,
    position: 'start',

    onDrop: function (source, target) {
      const move = game.move({
        from: source,
        to: target,
        promotion: 'q'
      });

      if (move === null) return 'snapback';

      window.setTimeout(makeAIMove, 250);
    }
  });

  function makeAIMove() {
    engine.postMessage("position fen " + game.fen());
    engine.postMessage("go depth 15");

    engine.onmessage = function (e) {
      if (e.data.startsWith("bestmove")) {
        const move = e.data.split(" ")[1];
        game.move({
          from: move.substring(0, 2),
          to: move.substring(2, 4),
          promotion: 'q'
        });
        board.position(game.fen());
      }
    };
  }
</script>
