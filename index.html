<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ© V12.1</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <style>
        :root { --gold: #d4af37; --bg: #050505; --panel: #121212; --white: #fff; }
        body { margin: 0; background: var(--bg); color: var(--white); font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: manipulation; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #splash { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 50px; height: 50px; border: 3px solid transparent; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ù†Ø¸Ù… */
        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #111; border-bottom: 2px solid var(--gold); box-sizing: border-box; }
        .btn-header { background: #222; color: var(--gold); border: 1px solid var(--gold); border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 1.1rem; }

        /* Ø§Ù„ØµÙØ­Ø§Øª */
        .page { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; position: absolute; }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .menu-card { background: var(--panel); width: 90%; max-width: 400px; border-radius: 20px; margin: 12px; padding: 20px; display: flex; align-items: center; gap: 20px; border-right: 6px solid var(--gold); cursor: pointer; transition: 0.2s; }
        .menu-card:active { transform: scale(0.97); }

        /* Ø§Ù„Ù„ÙˆØ­Ø© */
        #chess-board { display: grid; grid-template-columns: repeat(8, 1fr); width: 95vw; max-width: 400px; border: 4px solid #333; margin-top: 15px; }
        .sq { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .l { background: #eae9d2; } .d { background: #4b7399; }
        .sq img { width: 90%; pointer-events: none; }
        .hint::after { content: ""; width: 30%; height: 30%; background: rgba(0, 255, 0, 0.4); border-radius: 50%; position: absolute; }
        .sel { background: rgba(255, 255, 0, 0.4) !important; }

        /* Ø§Ù„Ø¨ØµØ±Ø© */
        .table-area { background: radial-gradient(circle, #237a2b 0%, #0a290c 100%); width: 95%; flex-grow: 1; max-height: 250px; border-radius: 25px; border: 4px solid #111; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px; padding: 15px; margin: 10px 0; overflow-y: auto; }
        .card-pro { width: 55px; height: 85px; background: #fff; border-radius: 8px; color: #000; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid #000; font-size: 16px; box-shadow: 3px 3px 6px rgba(0,0,0,0.5); cursor: pointer; }
        .back-c { background: #b71c1c; border-color: #fff; color: transparent; }

        .btn-gold { background: var(--gold); border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 45%; }
        #toast { position: fixed; top: 15%; background: var(--gold); color: #000; padding: 10px 30px; border-radius: 20px; font-weight: bold; display: none; z-index: 9999; }
    </style>
</head>
<body>

    <audio id="mus-bg" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3"></audio>
    <audio id="s-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3"></audio>
    <audio id="s-card" src="https://www.soundjay.com/misc/sounds/card-flip-1.mp3"></audio>

    <div id="splash"><div class="loader"></div><h2 style="color:var(--gold); margin-top:15px;">ROYAL GAMES</h2></div>
    <div id="toast"></div>

    <!-- Ø§Ù„Ù…Ù†ÙŠÙˆ -->
    <div id="p-lobby" class="page active">
        <h1 style="color:var(--gold); margin-top:50px;">Ø§Ù„Ù‚ØµØ± Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠ</h1>
        <div class="menu-card" onclick="nav('chess')"><span>â™Ÿï¸</span><div><b>Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ</b><p>ØµØ¹ÙˆØ¨Ø© Master | Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</p></div></div>
        <div class="menu-card" onclick="nav('basra')"><span>ğŸƒ</span><div><b>Ø¨ØµØ±Ø© 200 Ù†Ù‚Ø·Ø©</b><p>ØªØ­Ø¯ÙŠ Ø°ÙƒÙŠ | Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</p></div></div>
        <div class="menu-card" onclick="nav('profile')"><span>ğŸ‘¤</span><div><b>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</b><p>Ù†Ù‚Ø§Ø·Ùƒ ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ</p></div></div>
        <button class="btn-header" onclick="toggleM()" style="width:200px; margin-top:20px;">ğŸµ Ù…ÙˆØ³ÙŠÙ‚Ù‰</button>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ -->
    <div id="p-chess" class="page">
        <div class="header">
            <button class="btn-header" onclick="nav('lobby')">ğŸ </button>
            <div id="c-status" style="color:var(--gold); font-weight:bold;">Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„Ùƒ</div>
            <button class="btn-header" onclick="initChess()">ğŸ”„</button>
        </div>
        <div id="chess-board"></div>
        <div style="display:flex; width:90%; gap:10px; margin-top:15px;">
            <button class="btn-gold" onclick="cMode='ai'; initChess()">ğŸ¤– ÙƒÙ…Ø¨ÙŠÙˆØªØ±</button>
            <button class="btn-gold" onclick="startOnline('chess')">ğŸŒ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
        </div>
        <input type="text" id="c-room" style="margin-top:10px; padding:10px; border-radius:10px; text-align:center;" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¨ØµØ±Ø© -->
    <div id="p-basra" class="page">
        <div class="header">
            <button class="btn-header" onclick="nav('lobby')">ğŸ </button>
            <div style="color:var(--gold); font-weight:bold;">Ø¨ØµØ±Ø© 200</div>
            <button class="btn-header" onclick="initBasra()">ğŸ”„</button>
        </div>
        <div style="width:100%; display:flex; justify-content:space-around; padding:8px 0; background:#111;">
            <span>Ø£Ù†Øª: <b id="sc1">0</b></span> <span>Ø§Ù„Ø®ØµÙ…: <b id="sc2">0</b></span>
        </div>
        <div id="b-p2" style="display:flex; gap:5px; height:85px; margin-top:10px;"></div>
        <div id="b-table" class="table-area"></div>
        <div id="b-p1" style="display:flex; gap:5px; height:85px; margin-bottom:15px;"></div>
        <div style="display:flex; width:90%; gap:10px;">
            <button class="btn-gold" onclick="bMode='ai'; initBasra()">ğŸ¤– ÙƒÙ…Ø¨ÙŠÙˆØªØ±</button>
            <button class="btn-gold" onclick="startOnline('basra')">ğŸŒ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
        </div>
        <input type="text" id="b-room" style="margin-top:10px; padding:10px; border-radius:10px; text-align:center;" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ -->
    <div id="p-profile" class="page">
        <div class="header"><button class="btn-header" onclick="nav('lobby')">ğŸ </button><div>Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div></div>
        <div style="background:var(--panel); width:85%; padding:25px; border-radius:20px; border:1px solid var(--gold); margin-top:50px; text-align:center;">
            <h2 id="p-name" style="color:var(--gold)">Ù„Ø§Ø¹Ø¨ Ù…Ù„ÙƒÙŠ</h2>
            <p>ÙÙˆØ² Ø´Ø·Ø±Ù†Ø¬: <span id="st-c">0</span></p>
            <p>ÙÙˆØ² Ø¨ØµØ±Ø©: <span id="st-b">0</span></p>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="st-p">0</span></p>
            <button onclick="localStorage.clear(); location.reload();" style="background:red; color:white; padding:10px; border-radius:10px; border:none; margin-top:20px;">ØªØµÙÙŠØ±</button>
        </div>
    </div>

    <script>
        // --- Firebase ---
        const firebaseConfig = { apiKey: "AIzaSyDmhy8ToQ3LmvifZT7Foz9GfoPXLNlrYLs", projectId: "royal-games-imp" }; // Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§
        firebase.initializeApp(firebaseConfig);
        const rtdb = firebase.database();
        const store = firebase.firestore();
        let myId = localStorage.getItem('r_uid') || "u_" + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('r_uid', myId);

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø© ---
        window.onload = () => setTimeout(() => document.getElementById('splash').style.display='none', 1500);
        function nav(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-' + id).classList.add('active');
            if(id === 'profile') syncProfile();
        }
        function msg(t) { const el = document.getElementById('toast'); el.innerText=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1500); }
        function playS(id) { let a=document.getElementById(id); a.currentTime=0; a.play().catch(()=>{}); }
        let isM=false; function toggleM() { let m=document.getElementById('mus-bg'); isM?m.pause():m.play(); isM=!isM; }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©) ---
        let chess = new Chess(), cMode='ai', cRoom='', selSq=null;
        function initChess() {
            chess.reset(); // ØªØµÙÙŠØ± Ø¹Ù‚Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
            selSq = null;  // ØªØµÙÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            const b = document.getElementById('chess-board'); b.innerHTML='';
            for(let i=0; i<64; i++) {
                const r=Math.floor(i/8), c=i%8, n=String.fromCharCode(97+c)+(8-r);
                const s=document.createElement('div'); s.className=`sq ${(r+c)%2===0?'l':'d'}`;
                s.dataset.n=n; s.onclick=()=>handleChess(n); b.appendChild(s);
            }
            renderChess();
            document.getElementById('c-status').innerText = "Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„Ùƒ";
            msg("ØªÙ… Ø¨Ø¯Ø¡ Ø¬ÙŠÙ… Ø¬Ø¯ÙŠØ¯");
        }

        function renderChess() {
            document.querySelectorAll('.sq').forEach(s => {
                s.innerHTML=''; s.classList.remove('hint','sel');
                const p = chess.get(s.dataset.n);
                if(p) { let img=document.createElement('img'); img.src=`https://chessboardjs.com/img/chesspieces/wikipedia/${p.color}${p.type.toUpperCase()}.png`; s.appendChild(img); }
            });
        }

        function handleChess(sq) {
            if(document.querySelector(`[data-n="${sq}"]`).classList.contains('hint')) {
                const mv = { from: selSq, to: sq, promotion: 'q' };
                chess.move(mv); playS('s-move'); renderChess();
                if(cMode==='online') rtdb.ref(`rooms/chess/${cRoom}`).set({m: mv, p: myId, t: Date.now()});
                if(!chess.game_over() && cMode==='ai') setTimeout(masterAI, 600);
                checkEnd('chess'); return;
            }
            const p = chess.get(sq);
            if(p && p.color===chess.turn()) {
                selSq=sq; renderChess(); document.querySelector(`[data-n="${sq}"]`).classList.add('sel');
                chess.moves({square:sq, verbose:true}).forEach(m => document.querySelector(`[data-n="${m.to}"]`).classList.add('hint'));
            }
        }

        function masterAI() {
            const moves = chess.moves({verbose:true});
            if(moves.length===0) return;
            const vals = {p:10, n:32, b:33, r:50, q:90, k:900};
            moves.sort((a,b) => ((b.captured ? vals[b.captured] : 0) + (b.san.includes('+')?10:0)) - ((a.captured ? vals[a.captured] : 0) + (a.san.includes('+')?10:0)));
            chess.move(moves[0]); playS('s-move'); renderChess(); checkEnd('chess');
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨ØµØ±Ø© (Smart Logic) ---
        let bDeck=[], bTable=[], bP1=[], bP2=[], bS1=0, bS2=0, bTurn=1, bMode='ai';
        function initBasra() {
            bS1=0; bS2=0; bTurn=1; 
            newB();
            msg("Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠ Ø§Ù„Ø¨ØµØ±Ø©");
        }
        function newB() {
            bDeck=[]; ['â™ ','â™£','â™¥','â™¦'].forEach(s => ['A','2','3','4','5','6','7','8','9','10','J','Q','K'].forEach(r => bDeck.push({r,s,c:(s==='â™¥'||s==='â™¦')?'red':'black'})));
            bDeck.sort(()=>Math.random()-0.5);
            bTable = bDeck.splice(0,4); dealB();
        }
        function dealB() {
            if(bDeck.length>0) { bP1=bDeck.splice(0,4); bP2=bDeck.splice(0,4); renderB(); }
            else if(bP1.length===0 && bP2.length===0) newB();
        }
        function renderB() {
            const tA=document.getElementById('b-table'), p1A=document.getElementById('b-p1'), p2A=document.getElementById('b-p2');
            tA.innerHTML=''; p1A.innerHTML=''; p2A.innerHTML='';
            bTable.forEach(c => tA.appendChild(createC(c, false)));
            bP1.forEach((c,i) => { let el=createC(c,false); if(bTurn===1) el.onclick=()=>playB(i,1); p1A.appendChild(el); });
            bP2.forEach((c,i) => { 
                let hid = (bMode==='ai' || bTurn===1); let el=createC(c,hid); 
                p2A.appendChild(el); 
            });
            document.getElementById('sc1').innerText=bS1; document.getElementById('sc2').innerText=bS2;
        }
        function createC(card, hid) {
            const d=document.createElement('div'); d.className='card-pro'+(hid?' back-c':'')+(card.c==='red'?' red':'');
            d.innerHTML = hid ? '' : `<span>${card.r}</span><span style="font-size:24px">${card.s}</span>`;
            return d;
        }
        function playB(idx, p) {
            playS('s-card'); const hand = p===1?bP1:bP2; const card = hand.splice(idx,1)[0];
            let gain = 0; let mIdx = bTable.findIndex(c => c.r===card.r);
            if(card.r==='J' || (card.r==='7' && card.s==='â™¦')) {
                if(bTable.length>0) { gain=bTable.length+1; bTable=[]; msg("Ø¨ØµØ±Ø©! ğŸ”¥"); } else bTable.push(card);
            } else if(mIdx!==-1) {
                gain=2; bTable.splice(mIdx,1); if(bTable.length===0) { gain+=10; msg("Ø¨ØµØ±Ø©! ğŸ’¥"); }
            } else bTable.push(card);
            if(p===1) bS1+=gain; else bS2+=gain; bTurn = p===1?2:1; renderB();
            if(bP1.length===0 && bP2.length===0) dealB();
            if(bMode==='ai' && bTurn===2) setTimeout(bAI, 1000);
            checkEnd('basra');
        }
        function bAI() {
            let idx = 0;
            for(let i=0; i<bP2.length; i++) { if(bTable.some(c=>c.r===bP2[i].r) || bP2[i].r==='J') { idx=i; break; } }
            playB(idx, 2);
        }

        // --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ---
        async function syncProfile() {
            const doc = await store.collection('users').doc(myId).get();
            if(doc.exists) {
                const d = doc.data();
                document.getElementById('st-c').innerText=d.cw||0;
                document.getElementById('st-b').innerText=d.bw||0;
                document.getElementById('st-p').innerText=d.pts||0;
            }
        }
        function checkEnd(g) {
            if(g==='chess' && chess.game_over()) { alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¬ÙŠÙ…!"); nav('lobby'); }
            if(g==='basra' && (bS1>=200 || bS2>=200)) { alert("ÙˆØµÙ„ Ø£Ø­Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù€ 200!"); nav('lobby'); }
        }
    </script>
</body>
</html>
