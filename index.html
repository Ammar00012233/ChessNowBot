<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø´Ø·Ø±Ù†Ø¬ Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹</title>
  <script src="https://unpkg.com/chess.js@1.0.0-beta.6/chess.min.js"></script>
  <script src="https://unpkg.com/@lichess-org/stockfish.wasm@default/dist/stockfish.js"></script>
  <style>
    body { background: #0a0a0a; color: white; font-family: Arial; text-align: center; padding: 10px; margin: 0; }
    h1 { font-size: 24px; margin: 10px 0; }
    #board { display: grid; grid-template-columns: repeat(8, 1fr); width: min(95vw, 500px); margin: 20px auto; border: 3px solid #333; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .square { height: 50px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; user-select: none; transition: all 0.2s; position: relative; }
    .light { background: #f0d9b5; color: #000; }
    .dark { background: #b58863; color: #fff; }
    .selected { background: #ffeb3b !important; box-shadow: inset 0 0 20px gold; }
    .legal { background: rgba(0,255,0,0.6) !important; box-shadow: inset 0 0 15px lime; }
    .last-move { background: rgba(255,255,0,0.7) !important; }
    button { padding: 12px 24px; font-size: 18px; margin: 10px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #1976D2; }
    #status { font-size: 20px; font-weight: bold; margin: 20px; }
    #loading { color: #FFD700; font-size: 18px; }
    @media (max-width: 500px) { .square { height: 45px; font-size: 28px; } }
  </style>
</head>
<body>
  <h1>â™Ÿï¸ Ø´Ø·Ø±Ù†Ø¬ Ø¶Ø¯ AI Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ â™Ÿï¸</h1>
  <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù‚Ø·Ø¹Ø© â†’ ØªØ¨Ø±Ø² Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ â†’ Ø§Ø¶ØºØ· Ø§Ù„ÙˆØ¬Ù‡Ø© (Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„!)</p>
  <div id="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Stockfish Ø§Ù„Ù‚ÙˆÙŠ... Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø³</div>
  <div id="board"></div>
  <button id="newGame">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
  <button id="whiteBtn">Ø§Ù„Ø¹Ø¨ Ø£Ø¨ÙŠØ¶ (Ø£Ù†Øª ØªØ¨Ø¯Ø£)</button>
  <button id="blackBtn">Ø§Ù„Ø¹Ø¨ Ø£Ø³ÙˆØ¯ (AI ÙŠØ¨Ø¯Ø£)</button>
  <div id="status">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</div>

  <script>
    const game = new Chess();
    let board = document.getElementById('board');
    let engine;
    let selected = null;
    let aiThinking = false;
    let playerColor = 'w'; // white by default

    // Unicode pieces
    const pieceMap = {
      'K': 'â™”', 'Q': 'â™•', 'R': 'â™–', 'B': 'â™—', 'N': 'â™˜', 'P': 'â™™',
      'k': 'â™š', 'q': 'â™›', 'r': 'â™œ', 'b': 'â™', 'n': 'â™', 'p': 'â™Ÿ'
    };

    // Create board
    function createBoard() {
      board.innerHTML = '';
      for (let row = 7; row >= 0; row--) {
        for (let col = 0; col < 8; col++) {
          const square = document.createElement('div');
          square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
          square.dataset.square = String.fromCharCode(97 + col) + (row + 1);
          square.onclick = () => handleClick(square.dataset.square);
          board.appendChild(square);
        }
      }
    }

    function renderBoard() {
      const fen = game.fen().split(' ')[0];
      const rows = fen.split('/');
      document.querySelectorAll('.square').forEach(sq => sq.textContent = '');
      rows.forEach((row, r) => {
        let col = 0;
        for (let char of row) {
          if (!isNaN(char)) {
            col += parseInt(char);
          } else {
            const sq = document.querySelector(`[data-square="\( {String.fromCharCode(97 + col)} \){8 - r}"]`);
            sq.textContent = pieceMap[char];
            col++;
          }
        }
      });
    }

    function handleClick(square) {
      if (aiThinking || game.turn() !== playerColor[0]) return;
      if (selected) {
        // Clear highlights
        clearHighlights();
        const move = game.move({ from: selected, to: square, promotion: 'q' });
        if (move) {
          renderBoard();
          highlightLastMove(selected, square);
          aiMove();
        }
        selected = null;
      } else {
        const moves = game.moves({ square, verbose: true });
        if (moves.length > 0) {
          selected = square;
          document.querySelector(`[data-square="${square}"]`).classList.add('selected');
          moves.forEach(m => document.querySelector(`[data-square="${m.to}"]`).classList.add('legal'));
        }
      }
    }

    function clearHighlights() {
      document.querySelectorAll('.square').forEach(sq => {
        sq.classList.remove('selected', 'legal', 'last-move');
      });
    }

    function highlightLastMove(from, to) {
      document.querySelector(`[data-square="${from}"]`).classList.add('last-move');
      document.querySelector(`[data-square="${to}"]`).classList.add('last-move');
    }

    async function initEngine() {
      engine = Stockfish();
      engine.onmessage = (event) => {
        if (event && event.data?.startsWith('bestmove')) {
          const move = event.data.split(' ')[1];
          game.move(move);
          renderBoard();
          updateStatus();
          aiThinking = false;
          document.getElementById('loading').style.display = 'none';
        }
      };
      engine.postMessage('uci');
      engine.postMessage('setoption name Skill Level value 20');
      engine.postMessage('setoption name Threads value 4');
      engine.postMessage('ucinewgame');
      engine.postMessage('isready');
    }

    function aiMove() {
      if (game.game_over()) return;
      aiThinking = true;
      document.getElementById('loading').textContent = 'Ø§Ù„Ù€AI Ø¨ÙŠØ­Ø³Ø¨... (Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹!)';
      document.getElementById('loading').style.display = 'block';
      engine.postMessage('position fen ' + game.fen());
      engine.postMessage('go depth 28'); // ØµØ¹ÙˆØ¨Ø© Ø±Ù‡ÙŠØ¨Ø©
    }

    function updateStatus() {
      let status = '';
      if (game.in_checkmate()) status = game.turn() === playerColor[0] ? 'ğŸ‰ ÙØ²Øª!' : 'ğŸ’€ Ø®Ø³Ø±Øª!';
      else if (game.in_draw()) status = 'ğŸ¤ ØªØ¹Ø§Ø¯Ù„';
      else status = game.turn() === playerColor[0] ? 'Ø¯ÙˆØ±Ùƒ!' : 'Ø¯ÙˆØ± Ø§Ù„Ù€AI';
      document.getElementById('status').innerText = status;
    }

    // Events
    document.getElementById('newGame').onclick = () => {
      game.reset();
      playerColor = 'w';
      clearHighlights();
      renderBoard();
      updateStatus();
      aiThinking = false;
    };
    document.getElementById('whiteBtn').onclick = () => { playerColor = 'w'; document.getElementById('newGame').click(); };
    document.getElementById('blackBtn').onclick = () => {
      playerColor = 'b';
      document.getElementById('newGame').click();
      aiMove();
    };

    // Start
    createBoard();
    renderBoard();
    initEngine();
    setTimeout(() => {
      document.getElementById('loading').style.display = 'none';
      updateStatus();
    }, 2000);
  </script>
</body>
</html>
