<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ© V8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        :root { --gold: #d4af37; --bg: #0d0d0d; --panel: #1a1a1a; --white: #fff; --green: #1b5e20; }
        body { margin: 0; background: var(--bg); color: var(--white); font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: manipulation; }
        
        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªÙ†Ù‚Ù„ */
        .page { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; position: absolute; }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .game-header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #111; border-bottom: 2px solid var(--gold); z-index: 1001; }
        .header-btns { display: flex; gap: 8px; }
        .nav-btn { background: #333; color: white; border: 1px solid var(--gold); border-radius: 8px; padding: 6px 12px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; }

        /* Ø§Ù„Ù„ÙˆØ¨ÙŠ (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) */
        .lobby-title { margin-top: 30px; color: var(--gold); font-size: 2.2rem; text-shadow: 0 0 10px var(--gold); }
        .game-card { background: var(--panel); width: 90%; max-width: 380px; border-radius: 15px; margin: 10px; padding: 20px; display: flex; align-items: center; gap: 20px; border: 1px solid #333; cursor: pointer; }

        /* Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ */
        #chess-board { display: grid; grid-template-columns: repeat(8, 1fr); width: 95vw; max-width: 380px; border: 4px solid #333; margin-top: 10px; }
        .sq { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .l { background: #f0d9b5; } .d { background: #b58863; }
        .sq img { width: 90%; }
        .hint::after { content: ""; width: 30%; height: 30%; background: rgba(0, 255, 0, 0.4); border-radius: 50%; position: absolute; }
        .sel { background: rgba(255, 255, 0, 0.5) !important; }

        /* Ø§Ù„Ø¨ØµØ±Ø© - Ø·Ø§ÙˆÙ„Ø© ÙƒØ¨ÙŠØ±Ø© ÙˆØ±Ø¤ÙŠØ© ÙˆØ§Ø¶Ø­Ø© */
        .score-box { background: rgba(212, 175, 55, 0.1); width: 100%; padding: 10px 0; display: flex; justify-content: space-around; border-bottom: 1px solid #333; font-weight: bold; }
        .table { background: radial-gradient(circle, #2e7d32 0%, #113813 100%); width: 95%; flex-grow: 1; max-height: 280px; border-radius: 20px; border: 4px solid #0a290c; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px; padding: 15px; margin: 10px 0; overflow-y: auto; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }
        .card-ui { width: 60px; height: 90px; background: #fff; border-radius: 8px; color: #000; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid #000; font-size: 18px; box-shadow: 3px 3px 6px rgba(0,0,0,0.4); cursor: pointer; }
        .card-hidden { background: #b71c1c; border-color: #fff; color: transparent; pointer-events: none; }
        .red { color: #d32f2f; }
        
        /* Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        .profile-card { background: var(--panel); width: 85%; padding: 25px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; margin-top: 20px; }
        .stat-line { font-size: 1.2rem; margin: 15px 0; display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†) */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: right; }
        .modal-content { background: #222; padding: 20px; border-radius: 15px; border: 1px solid var(--gold); max-width: 90%; line-height: 1.6; }

        button { background: var(--gold); border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; color: black; }
        #msg { position: fixed; top: 40%; background: var(--gold); color: black; padding: 10px 30px; border-radius: 20px; font-weight: bold; display: none; z-index: 6000; }
    </style>
</head>
<body>

    <!-- Ø§Ù„ØµÙˆØªÙŠØ§Øª -->
    <audio id="bg-music" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3"></audio>
    <audio id="snd-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3"></audio>
    <audio id="snd-card" src="https://www.soundjay.com/misc/sounds/card-flip-1.mp3"></audio>

    <div id="msg">Ø¨ØµØ±Ø©! ğŸ”¥</div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† -->
    <div id="rules-modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content">
            <h2 style="color:var(--gold); text-align:center;">Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            <div id="rules-text"></div>
            <p style="text-align:center; color:var(--gold); margin-top:10px;">Ø§Ø¶ØºØ· ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ù„Ù„Ø¥ØºÙ„Ø§Ù‚</p>
        </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="page-lobby" class="page active">
        <h1 class="lobby-title">Ø§Ù„Ù‚ØµØ± Ø§Ù„Ù…Ù„ÙƒÙŠ</h1>
        <div class="game-card" onclick="openPage('chess')"><span>â™Ÿï¸</span><div><b>Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ</b><p>Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø£Ù‚ÙˆÙ‰</p></div></div>
        <div class="game-card" onclick="openPage('basra')"><span>ğŸƒ</span><div><b>Ø¨ØµØ±Ø© 200 Ù†Ù‚Ø·Ø©</b><p>ØªØ­Ø¯ÙŠ Ø§Ù„ÙƒÙˆØªØ´ÙŠÙ†Ø© Ø§Ù„Ù…ØµØ±ÙŠ</p></div></div>
        <div class="game-card" onclick="openPage('profile')"><span>ğŸ‘¤</span><div><b>Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠ</b><p>Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ ÙˆÙ†Ù‚Ø§Ø·Ùƒ</p></div></div>
        <button onclick="toggleMusic()" id="lobby-music-btn" style="margin-top:20px; width:200px;">ğŸ¶ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</button>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ -->
    <div id="page-chess" class="page">
        <div class="game-header">
            <button class="nav-btn" onclick="openPage('lobby')">ğŸ </button>
            <div class="header-btns">
                <button class="nav-btn" onclick="showRules('chess')">â“</button>
                <button class="nav-btn" onclick="toggleMusic()" id="c-music-btn">ğŸ¶</button>
                <button class="nav-btn" onclick="initChess(chessMode)">ğŸ”„</button>
            </div>
        </div>
        <div id="chess-status" style="margin:10px; color:var(--gold); font-weight:bold;">Ø¯ÙˆØ±: Ø§Ù„Ø£Ø¨ÙŠØ¶</div>
        <div id="chess-board"></div>
        <div style="display:flex; gap:10px;">
            <button onclick="initChess('ai')">ğŸ¤– Ø¶Ø¯ Ø§Ù„Ù…Ø­ØªØ±Ù</button>
            <button onclick="initChess('friend')">ğŸ‘¥ Ø¶Ø¯ ØµØ¯ÙŠÙ‚</button>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¨ØµØ±Ø© -->
    <div id="page-basra" class="page">
        <div class="game-header">
            <button class="nav-btn" onclick="openPage('lobby')">ğŸ </button>
            <div class="header-btns">
                <button class="nav-btn" onclick="showRules('basra')">â“</button>
                <button class="nav-btn" onclick="toggleMusic()" id="b-music-btn">ğŸ¶</button>
                <button class="nav-btn" onclick="initBasra(bMode)">ğŸ”„</button>
            </div>
        </div>
        <div class="score-box">
            <span>Ø£Ù†Øª: <b id="sc1" style="color:var(--gold)">0</b></span>
            <span style="color:#aaa">Ø§Ù„Ù‡Ø¯Ù: 200</span>
            <span>Ø®ØµÙ…Ùƒ: <b id="sc2" style="color:var(--gold)">0</b></span>
        </div>
        <div id="b-p2-hand" style="display:flex; gap:5px; height:90px; margin-top:5px;"></div>
        <div id="b-table" class="table"></div>
        <div id="b-p1-hand" style="display:flex; gap:8px; height:95px; margin-bottom:10px;"></div>
        <div id="b-init">
            <button onclick="initBasra('ai')">ğŸ¤– Ø¶Ø¯ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</button>
            <button onclick="initBasra('friend')">ğŸ‘¥ Ø¶Ø¯ ØµØ¯ÙŠÙ‚</button>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ -->
    <div id="page-profile" class="page">
        <div class="game-header">
            <button class="nav-btn" onclick="openPage('lobby')">ğŸ </button>
            <div class="game-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
        </div>
        <div class="profile-card">
            <h2 style="color:var(--gold); margin-bottom:20px;">ğŸ‘¤ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ</h2>
            <div class="stat-line"><span>ÙÙˆØ² Ø´Ø·Ø±Ù†Ø¬:</span> <b id="stat-chess">0</b></div>
            <div class="stat-line"><span>ÙÙˆØ² Ø¨ØµØ±Ø©:</span> <b id="stat-basra">0</b></div>
            <div class="stat-line"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·:</span> <b id="stat-pts">0</b></div>
            <button onclick="localStorage.clear(); location.reload();" style="background:#e74c3c; margin-top:20px;">ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>

    <script>
        // --- 1. Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ---
        function openPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            if(id === 'profile') loadStats();
        }
        function snd(id) { let a = document.getElementById(id); a.currentTime=0; a.play().catch(()=>{}); }
        function showMsg(m) { const el = document.getElementById('msg'); el.innerText = m; el.style.display='block'; setTimeout(()=>el.style.display='none', 1500); }

        function showRules(game) {
            const modal = document.getElementById('rules-modal');
            const text = document.getElementById('rules-text');
            if(game === 'chess') {
                text.innerHTML = "â€¢ Ø§Ù„Ø£Ø¨ÙŠØ¶ ÙŠØ¨Ø¯Ø£ Ø£ÙˆÙ„Ø§Ù‹.<br>â€¢ ÙƒØ´ Ù…Ù„Ùƒ ÙŠØ¹Ù†ÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©.<br>â€¢ Ø§Ù„ØªØ¨ÙŠÙŠØª ÙˆØ§Ù„Ø£ÙƒÙ„ Ø¨Ø§Ù„ØªØ¬Ø§ÙˆØ² Ù…Ø¯Ø¹ÙˆÙ…Ø§Ù†.<br>â€¢ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…Ø¨Ø±Ù…Ø¬ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ù…Ø­ØªØ±Ù.";
            } else {
                text.innerHTML = "â€¢ Ø§Ù„Ù‡Ø¯Ù: Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€ 200 Ù†Ù‚Ø·Ø©.<br>â€¢ Ø§Ù„ÙˆÙ„Ø¯ (J) ÙˆØ§Ù„Ù€ 7 Ø§Ù„ÙƒÙˆÙ…ÙŠ (â™¦) ÙŠØ¬Ù…Ø¹Ø§Ù† ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØª.<br>â€¢ Ø§Ù„Ø¨ØµØ±Ø©: Ù…Ø³Ø­ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¨ÙƒØ§Ø±Øª Ù…Ù…Ø§Ø«Ù„ = 10 Ù†Ù‚Ø§Ø·.<br>â€¢ Ø£ÙŠ ÙƒØ§Ø±ØªÙŠÙ† Ù…ØªÙ…Ø§Ø«Ù„ÙŠÙ† = Ù†Ù‚Ø·ØªÙŠÙ†.";
            }
            modal.style.display = 'flex';
        }

        let musicPlaying = false;
        function toggleMusic() {
            const m = document.getElementById('bg-music');
            musicPlaying = !musicPlaying;
            musicPlaying ? m.play() : m.pause();
            const icon = musicPlaying ? "ğŸ”‡" : "ğŸ¶";
            document.getElementById('c-music-btn').innerText = icon;
            document.getElementById('b-music-btn').innerText = icon;
            document.getElementById('lobby-music-btn').innerText = musicPlaying ? "ğŸ”‡ ÙƒØªÙ… Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰" : "ğŸ¶ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰";
        }

        // --- 2. Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ---
        function loadStats() {
            let s = JSON.parse(localStorage.getItem('royal_v8_stats')) || {cw: 0, bw: 0, pts: 0};
            document.getElementById('stat-chess').innerText = s.cw;
            document.getElementById('stat-basra').innerText = s.bw;
            document.getElementById('stat-pts').innerText = s.pts;
        }
        function saveWin(type, pts) {
            let s = JSON.parse(localStorage.getItem('royal_v8_stats')) || {cw: 0, bw: 0, pts: 0};
            if(type === 'chess') s.cw++; else s.bw++;
            s.pts += pts;
            localStorage.setItem('royal_v8_stats', JSON.stringify(s));
        }

        // --- 3. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ ---
        let chess = new Chess(), chessMode = 'ai', selSq = null;
        function initChess(m) {
            chessMode = m; chess.reset(); const b = document.getElementById('chess-board'); b.innerHTML = '';
            for (let i=0; i<64; i++) {
                const r=Math.floor(i/8), c=i%8, name=String.fromCharCode(97+c)+(8-r);
                const sq = document.createElement('div'); sq.className = `sq ${(r+c)%2===0?'l':'d'}`;
                sq.dataset.name = name; sq.onclick = () => handleChess(name); b.appendChild(sq);
            }
            renderChess();
        }
        function renderChess() {
            document.querySelectorAll('.sq').forEach(el => {
                el.innerHTML = ''; el.classList.remove('hint', 'sel');
                const p = chess.get(el.dataset.name);
                if (p) {
                    const img = document.createElement('img');
                    img.src = `https://chessboardjs.com/img/chesspieces/wikipedia/${p.color}${p.type.toUpperCase()}.png`;
                    el.appendChild(img);
                }
            });
            document.getElementById('chess-status').innerText = chess.turn()==='w'?"Ø¯ÙˆØ±: Ø§Ù„Ø£Ø¨ÙŠØ¶":"Ø¯ÙˆØ±: Ø§Ù„Ø£Ø³ÙˆØ¯";
            if(chess.game_over()) {
                alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¬ÙŠÙ…!");
                if(chess.in_checkmate() && chess.turn() === 'b') saveWin('chess', 100);
                openPage('lobby');
            }
        }
        function handleChess(sq) {
            if (document.querySelector(`[data-name="${sq}"]`).classList.contains('hint')) {
                chess.move({ from: selSq, to: sq, promotion: 'q' }); snd('snd-move'); renderChess();
                if (!chess.game_over() && chessMode === 'ai') setTimeout(makeChessAI, 600);
                return;
            }
            const p = chess.get(sq);
            if (p && p.color === chess.turn()) {
                selSq = sq; renderChess();
                document.querySelector(`[data-name="${sq}"]`).classList.add('sel');
                chess.moves({ square: sq, verbose: true }).forEach(m => document.querySelector(`[data-name="${m.to}"]`).classList.add('hint'));
            }
        }
        function makeChessAI() {
            const moves = chess.moves({ verbose: true });
            if (moves.length === 0) return;
            moves.sort((a, b) => (b.captured ? 1 : 0) - (a.captured ? 1 : 0));
            chess.move(moves[0]); snd('snd-move'); renderChess();
        }

        // --- 4. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨ØµØ±Ø© V8 ---
        let bDeck=[], bTable=[], bP1=[], bP2=[], bSc1=0, bSc2=0, bTurn=1, bMode='ai';
        function initBasra(m) {
            bMode = m; bSc1 = 0; bSc2 = 0; bTurn = 1;
            document.getElementById('b-init').style.display = 'none';
            newRound();
        }
        function newRound() {
            bDeck = [];
            ['â™ ','â™£','â™¥','â™¦'].forEach(s => ['A','2','3','4','5','6','7','8','9','10','J','Q','K'].forEach(r => bDeck.push({r, s, c: (s==='â™¥'||s==='â™¦')?'red':'black'})));
            bDeck.sort(() => Math.random() - 0.5);
            bTable = bDeck.splice(0, 4);
            dealCards();
        }
        function dealCards() {
            if (bDeck.length > 0) { bP1 = bDeck.splice(0, 4); bP2 = bDeck.splice(0, 4); renderBasra(); }
            else if (bP1.length === 0 && bP2.length === 0) setTimeout(newRound, 1000);
        }
        function renderBasra() {
            const tA=document.getElementById('b-table'), p1A=document.getElementById('b-p1-hand'), p2A=document.getElementById('b-p2-hand');
            tA.innerHTML=''; p1A.innerHTML=''; p2A.innerHTML='';
            bTable.forEach(c => tA.appendChild(createBCard(c, false)));
            bP1.forEach((c, i) => { const el=createBCard(c, false); if(bTurn === 1) el.addEventListener('click', () => playBCard(i, 1)); p1A.appendChild(el); });
            bP2.forEach((c, i) => { 
                const hid = (bMode==='ai' || bTurn===1);
                const el = createBCard(c, hid);
                if(bTurn === 2 && bMode === 'friend') el.addEventListener('click', () => playBCard(i, 2));
                p2A.appendChild(el); 
            });
            document.getElementById('sc1').innerText = bSc1;
            document.getElementById('sc2').innerText = bSc2;
            if (bSc1 >= 200 || bSc2 >= 200) {
                alert(bSc1 >= 200 ? "Ø£Ù†Øª Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ù…Ù„ÙƒÙŠ! ğŸ†" : "Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙØ§Ø²!");
                if(bSc1 >= 200) saveWin('basra', bSc1);
                location.reload();
            }
        }
        function createBCard(card, hid) {
            const div = document.createElement('div');
            div.className = 'card-ui' + (hid?' card-hidden':'') + (card.c==='red'?' red':'');
            div.innerHTML = hid ? '' : `<span>${card.r}</span><span style="font-size:20px">${card.s}</span>`;
            return div;
        }
        function playBCard(idx, p) {
            snd('snd-card');
            const hand = (p === 1) ? bP1 : bP2;
            if(!hand[idx]) return;
            const card = hand.splice(idx, 1)[0];
            let captured = 0;
            let matchIdx = bTable.findIndex(c => c.r === card.r);
            if (card.r === 'J' || (card.r === '7' && card.s === 'â™¦')) {
                if (bTable.length > 0) { captured = bTable.length + 1; bTable = []; showMsg("Ø¨ØµØ±Ø© Ù‚ÙˆÙŠØ©! ğŸ”¥"); if(captured === 1) captured = 10; } else { bTable.push(card); }
            } else if (matchIdx !== -1) {
                captured = 2; bTable.splice(matchIdx, 1); if (bTable.length === 0) { captured += 10; showMsg("Ø¨ØµØ±Ø©! ğŸ’¥"); }
            } else { bTable.push(card); }
            if(p === 1) bSc1 += captured; else bSc2 += captured;
            bTurn = (p === 1) ? 2 : 1;
            renderBasra();
            if (bP1.length === 0 && bP2.length === 0) setTimeout(dealCards, 800);
            if (bMode === 'ai' && bTurn === 2) setTimeout(makeBasraAI, 1000);
        }
        function makeBasraAI() {
            if (bP2.length === 0) return;
            let bestIdx = 0;
            for (let i=0; i<bP2.length; i++) { if (bTable.some(c => c.r === bP2[i].r) || bP2[i].r === 'J') { bestIdx = i; break; } }
            playBCard(bestIdx, 2);
        }
    </script>
</body>
</html>
