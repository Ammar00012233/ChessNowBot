<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoge Chess</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0-beta.6/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://unpkg.com/stockfish@16/src/stockfish.wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background:#121212; color:#fff; font-family:Arial; text-align:center; margin:0; padding:20px; }
        #profile { background:#1e1e1e; padding:20px; margin:20px auto; max-width:500px; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,0.5); }
        #points { font-size:3em; color:#77c353; font-weight:bold; }
        .stats { font-size:1.4em; margin:15px; }
        button { background:#77c353; color:#fff; border:none; padding:15px 30px; font-size:1.5em; border-radius:12px; margin:15px; cursor:pointer; }
        button:hover { background:#5a9b3a; }
        #board { width:min(95vw,500px); margin:20px auto; }
        #status { font-size:1.8em; margin:20px; font-weight:bold; }
        #loading { color:#ffeb3b; font-size:1.6em; margin:20px; }
    </style>
</head>
<body>
    <div id="profile">
        <h2>Ù…Ø±Ø­Ø¨Ø§ ÙŠØ§ <span id="player-name">Ù„Ø§Ø¹Ø¨</span>!</h2>
        <div id="points">0</div>
        <div class="stats">ÙÙˆØ²: <span id="wins">0</span> | Ø®Ø³Ø§Ø±Ø©: <span id="losses">0</span> | ØªØ¹Ø§Ø¯Ù„: <span id="draws">0</span></div>
    </div>

    <div id="game-area">
        <h2>Ø´Ø·Ø±Ù†Ø¬ Ø¶Ø¯ AI Ù‚ÙˆÙŠ Ø¬Ø¯Ù‹Ø§</h2>
        <div id="loading" style="display:none;">Ø§Ù„Ù€AI Ø¨ÙŠÙÙƒØ± Ø¨Ø¹Ù…Ù‚...</div>
        <div id="board"></div>
        <div id="status">Ø§Ø¶ØºØ· Ø²Ø± Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</div>
        <button onclick="newGame('w')">Ø§Ù„Ø¹Ø¨ Ø£Ø¨ÙŠØ¶ (Ø£Ù†Øª ØªØ¨Ø¯Ø£)</button>
        <button onclick="newGame('b')">Ø§Ù„Ø¹Ø¨ Ø£Ø³ÙˆØ¯ (AI ÙŠØ¨Ø¯Ø£)</button>
    </div>

    <audio id="move-sound" src="https://assets.mixkit.co/sfx/download/mixkit-chess-piece-move-2107.mp3"></audio>
    <audio id="win-sound" src="https://assets.mixkit.co/sfx/download/mixkit-winning-chimes-2015.mp3"></audio>

    <script>
        // Supabase config Ø¨ØªØ§Ø¹Ùƒ
        const supabaseUrl = 'https://jcgdxtnspmqwunzfkdqa.supabase.co';
        const supabaseKey = 'sb_publishable_yRrI83fceQxrCpug9LOIRg_GZoKR_d4';

        const { createClient } = supabase;
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const user = tg.initDataUnsafe?.user || { id: 999999999, first_name: 'Ù„Ø§Ø¹Ø¨' };
        document.getElementById('player-name').textContent = user.first_name || 'Ù„Ø§Ø¹Ø¨';

        // Ø¬Ù„Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
        async function loadProfile() {
            let { data, error } = await supabase
                .from('players')
                .select('*')
                .eq('telegram_id', user.id)
                .single();

            if (error || !data) {
                // ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                const { data: newData, error: newError } = await supabase
                    .from('players')
                    .insert({
                        telegram_id: user.id,
                        username: user.username || '',
                        first_name: user.first_name || 'Ù„Ø§Ø¹Ø¨'
                    })
                    .select()
                    .single();
                data = newData;
            }

            document.getElementById('points').textContent = data.points || 0;
            document.getElementById('wins').textContent = data.wins || 0;
            document.getElementById('losses').textContent = data.losses || 0;
            document.getElementById('draws').textContent = data.draws || 0;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
        async function updateStats(result) {
            let pointsChange = 0;
            let winsChange = 0;
            let lossesChange = 0;
            let drawsChange = 0;

            if (result === 'win') { pointsChange = 10; winsChange = 1; }
            else if (result === 'loss') { pointsChange = -5; lossesChange = 1; }
            else { pointsChange = 2; drawsChange = 1; }

            await supabase
                .from('players')
                .update({
                    points: supabase.raw('points + ?', pointsChange),
                    wins: supabase.raw('wins + ?', winsChange),
                    losses: supabase.raw('losses + ?', lossesChange),
                    draws: supabase.raw('draws + ?', drawsChange)
                })
                .eq('telegram_id', user.id);

            loadProfile();
        }

        const game = new Chess();
        let board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDrop: onDrop
        });
        let engine = STOCKFISH();

        engine.onmessage = (event) => {
            const line = event.data || event;
            if (line.includes('bestmove')) {
                const move = line.split(' ')[1];
                if (move && move !== '(none)') {
                    game.move(move);
                    board.position(game.fen());
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('status').textContent = 'Ø¯ÙˆØ±Ùƒ!';
                    moveSound.play();
                    checkGameEnd();
                }
            }
        };

        engine.postMessage('uci');
        engine.postMessage('setoption name Skill Level value 20');
        engine.postMessage('setoption name Threads value 4');

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            moveSound.play();
            if (game.game_over()) {
                checkGameEnd();
                return;
            }
            document.getElementById('loading').style.display = 'block';
            document.getElementById('status').textContent = 'Ø§Ù„Ù€AI Ø¨ÙŠÙÙƒØ±...';
            engine.postMessage('position fen ' + game.fen());
            engine.postMessage('go depth 30'); // ØµØ¹ÙˆØ¨Ø© Ø±Ù‡ÙŠØ¨Ø©
        }

        function checkGameEnd() {
            if (game.in_checkmate()) {
                const result = game.turn() === 'w' ? 'loss' : 'win'; // Ù„Ùˆ Ø¯ÙˆØ± Ø§Ù„Ø£Ø¨ÙŠØ¶ØŒ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø®Ø³Ø± Ù„Ùˆ Ù‡Ùˆ Ø£Ø¨ÙŠØ¶
                updateStats(result);
                document.getElementById('status').textContent = result === 'win' ? 'ÙØ²Øª! +10 Ù†Ù‚Ø§Ø· ğŸ‰' : 'Ø®Ø³Ø±Øª! -5 Ù†Ù‚Ø§Ø·';
                winSound.play();
            } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
                updateStats('draw');
                document.getElementById('status').textContent = 'ØªØ¹Ø§Ø¯Ù„! +2 Ù†Ù‚Ø§Ø·';
            }
        }

        let playerColor = 'w';
        function newGame(color) {
            playerColor = color;
            game.reset();
            board.position('start');
            document.getElementById('status').textContent = 'Ø¯ÙˆØ±Ùƒ!';
            document.getElementById('loading').style.display = 'none';
            if (color === 'b') {
                document.getElementById('loading').style.display = 'block';
                engine.postMessage('position fen ' + game.fen());
                engine.postMessage('go depth 30');
            }
        }

        const moveSound = document.getElementById('move-sound');
        const winSound = document.getElementById('win-sound');

        loadProfile(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù„Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
    </script>
</body>
</html>
