<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ© - V13 Online</title>
    
    <!-- Firebase SDK (Version Compat Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <style>
        :root { --gold: #d4af37; --bg: #050505; --panel: #121212; --white: #fff; }
        body { margin: 0; background: var(--bg); color: var(--white); font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: manipulation; }
        
        #splash { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 50px; height: 50px; border: 3px solid transparent; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #111; border-bottom: 2px solid var(--gold); box-sizing: border-box; }
        .btn-h { background: #222; color: var(--gold); border: 1px solid var(--gold); border-radius: 8px; padding: 6px 10px; cursor: pointer; }

        .page { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; position: absolute; }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .menu-card { background: var(--panel); width: 90%; max-width: 400px; border-radius: 20px; margin: 12px; padding: 20px; display: flex; align-items: center; gap: 20px; border-right: 6px solid var(--gold); cursor: pointer; }
        
        #chess-board { display: grid; grid-template-columns: repeat(8, 1fr); width: 95vw; max-width: 400px; border: 4px solid #333; margin-top: 15px; }
        .sq { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .l { background: #eae9d2; } .d { background: #4b7399; }
        .sq img { width: 90%; pointer-events: none; }
        .hint::after { content: ""; width: 30%; height: 30%; background: rgba(0, 255, 0, 0.4); border-radius: 50%; position: absolute; }
        .sel { background: rgba(255, 255, 0, 0.4) !important; }

        .table-area { background: radial-gradient(circle, #237a2b 0%, #0a290c 100%); width: 95%; flex-grow: 1; max-height: 250px; border-radius: 25px; border: 4px solid #111; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px; padding: 15px; margin: 10px 0; overflow-y: auto; }
        .card-pro { width: 55px; height: 85px; background: #fff; border-radius: 8px; color: #000; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid #000; font-size: 16px; box-shadow: 3px 3px 6px rgba(0,0,0,0.5); cursor: pointer; }
        
        .btn-gold { background: var(--gold); border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 45%; }
        #toast { position: fixed; top: 15%; background: var(--gold); color: #000; padding: 10px 30px; border-radius: 20px; font-weight: bold; display: none; z-index: 9999; }
    </style>
</head>
<body>

    <audio id="mus-bg" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3"></audio>
    <audio id="s-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3"></audio>
    <audio id="s-card" src="https://www.soundjay.com/misc/sounds/card-flip-1.mp3"></audio>

    <div id="splash"><div class="loader"></div><h2 style="color:var(--gold); margin-top:15px;">ROYAL GAMES</h2></div>
    <div id="toast"></div>

    <div id="p-lobby" class="page active">
        <h1 style="color:var(--gold); margin-top:50px;">Ø§Ù„Ù‚ØµØ± Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠ</h1>
        <div class="menu-card" onclick="nav('chess')"><span>â™Ÿï¸</span><div><b>Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ</b><p>Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø­Ù‚ÙŠÙ‚ÙŠ | Ø°ÙƒØ§Ø¡ Master</p></div></div>
        <div class="menu-card" onclick="nav('basra')"><span>ğŸƒ</span><div><b>Ø¨ØµØ±Ø© 200 Ù†Ù‚Ø·Ø©</b><p>ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</p></div></div>
        <div class="menu-card" onclick="nav('profile')"><span>ğŸ‘¤</span><div><b>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</b><p>Ù†Ù‚Ø§Ø·Ùƒ Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹</p></div></div>
        <button class="btn-h" onclick="toggleM()" style="width:200px; margin-top:20px;">ğŸµ Ù…ÙˆØ³ÙŠÙ‚Ù‰</button>
    </div>

    <!-- ØµÙØ­Ø§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ (Ù†ÙØ³ Ù‡ÙŠÙƒÙ„ V12.1) -->
    <div id="p-chess" class="page">
        <div class="header">
            <button class="btn-h" onclick="nav('lobby')">ğŸ </button>
            <div id="c-status" style="color:var(--gold); font-weight:bold;">Ø´Ø·Ø±Ù†Ø¬ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</div>
            <button class="btn-h" onclick="initChess()">ğŸ”„</button>
        </div>
        <div id="chess-board"></div>
        <div style="display:flex; width:90%; gap:10px; margin-top:10px;">
            <button class="btn-gold" onclick="cMode='ai'; initChess()">ğŸ¤– ÙƒÙ…Ø¨ÙŠÙˆØªØ±</button>
            <button class="btn-gold" onclick="startOnline('chess')">ğŸŒ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
        </div>
        <input type="text" id="c-room" style="margin-top:10px; padding:10px; border-radius:10px; text-align:center; width:80%;" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
    </div>

    <div id="p-basra" class="page">
        <div class="header"><button class="btn-h" onclick="nav('lobby')">ğŸ </button><div>Ø¨ØµØ±Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</div><button class="btn-h" onclick="initBasra()">ğŸ”„</button></div>
        <div style="width:100%; display:flex; justify-content:space-around; padding:8px 0; background:#111;"><span>Ø£Ù†Øª: <b id="sc1">0</b></span> <span>Ø§Ù„Ø®ØµÙ…: <b id="sc2">0</b></span></div>
        <div id="b-p2" style="display:flex; gap:5px; height:80px; margin-top:5px;"></div>
        <div id="b-table" class="table-area"></div>
        <div id="b-p1" style="display:flex; gap:5px; height:80px; margin-bottom:10px;"></div>
        <div style="display:flex; width:90%; gap:10px;"><button class="btn-gold" onclick="bMode='ai'; initBasra()">ğŸ¤– ÙƒÙ…Ø¨ÙŠÙˆØªØ±</button><button class="btn-gold" onclick="startOnline('basra')">ğŸŒ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button></div>
        <input type="text" id="b-room" style="margin-top:10px; padding:10px; border-radius:10px; text-align:center; width:80%;" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
    </div>

    <div id="p-profile" class="page">
        <div class="header"><button class="btn-h" onclick="nav('lobby')">ğŸ </button><div>Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ùƒ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</div></div>
        <div id="profile-cont" style="background:var(--panel); width:85%; padding:25px; border-radius:20px; border:1px solid var(--gold); margin-top:50px; text-align:center;">
            <p>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨...</p>
        </div>
    </div>

    <script>
        // --- 1. Ø±Ø¨Ø· Firebase Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmhy8ToQ3LmvifZT7Foz9GfoPXLNlrYLs",
            authDomain: "chess-online-7a911.firebaseapp.com",
            projectId: "chess-online-7a911",
            storageBucket: "chess-online-7a911.firebasestorage.app",
            messagingSenderId: "137588717582",
            appId: "1:137588717582:web:63e8b8b1b68efbe5c1645f",
            databaseURL: "https://chess-online-7a911-default-rtdb.firebaseio.com" // ØªÙ… Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø·
        };
        firebase.initializeApp(firebaseConfig);
        const rtdb = firebase.database();
        const store = firebase.firestore();

        let myId = localStorage.getItem('r_uid') || "player_" + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('r_uid', myId);

        // --- 2. Ù…Ø­Ø±Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù… ---
        window.onload = () => setTimeout(() => document.getElementById('splash').style.display='none', 1500);
        function nav(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-' + id).classList.add('active');
            if(id === 'profile') syncProfile();
        }
        function msg(t) { const el = document.getElementById('toast'); el.innerText=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1500); }
        function playS(id) { let a=document.getElementById(id); a.currentTime=0; a.play().catch(()=>{}); }
        let mus=false; function toggleM() { let m=document.getElementById('mus-bg'); mus?m.pause():m.play(); mus=!mus; }

        // --- 3. Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ---
        function startOnline(type) {
            const room = document.getElementById(type === 'chess' ? 'c-room' : 'b-room').value;
            if(!room) return alert("Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©!");
            msg("Ù…ØªØµÙ„ Ø¨Ø§Ù„ØºØ±ÙØ© " + room);
            
            if(type === 'chess') {
                cMode = 'online'; cRoom = room; initChess();
                rtdb.ref(`rooms/chess/${room}`).on('value', snap => {
                    const d = snap.val();
                    if(d && d.p !== myId) { chess.move(d.m); renderChess(); playS('s-move'); }
                });
            } else {
                bMode = 'online'; bRoom = room; initBasra();
                rtdb.ref(`rooms/basra/${room}`).on('value', snap => {
                    const d = snap.val();
                    if(d && d.p !== myId) { syncBasra(d.m); }
                });
            }
        }

        async function syncProfile() {
            const cont = document.getElementById('profile-cont');
            const doc = await store.collection('users').doc(myId).get();
            let d = doc.exists ? doc.data() : {cw:0, bw:0, pts:0};
            if(!doc.exists) await store.collection('users').doc(myId).set(d);
            
            cont.innerHTML = `
                <h2 style="color:var(--gold)">${myId}</h2>
                <p>ÙÙˆØ² Ø´Ø·Ø±Ù†Ø¬: ${d.cw}</p>
                <p>ÙÙˆØ² Ø¨ØµØ±Ø©: ${d.bw}</p>
                <p style="font-size:1.5rem; color:var(--gold)">Ø§Ù„Ù†Ù‚Ø§Ø·: ${d.pts}</p>
                <button onclick="localStorage.clear(); location.reload();" style="background:red; color:white; padding:10px; border-radius:10px; border:none; margin-top:20px;">ØªØµÙÙŠØ±</button>
            `;
        }

        // --- 4. Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ (Master AI) ---
        let chess = new Chess(), cMode='ai', cRoom='', selSq=null;
        function initChess() {
            chess.reset(); selSq=null; const b = document.getElementById('chess-board'); b.innerHTML='';
            for(let i=0; i<64; i++) {
                const r=Math.floor(i/8), c=i%8, n=String.fromCharCode(97+c)+(8-r);
                const s=document.createElement('div'); s.className=`sq ${(r+c)%2===0?'l':'d'}`;
                s.dataset.n=n; s.onclick=()=>handleChess(n); b.appendChild(s);
            }
            renderChess();
        }
        function renderChess() {
            document.querySelectorAll('.sq').forEach(s => {
                s.innerHTML=''; s.classList.remove('hint','sel');
                const p = chess.get(s.dataset.n);
                if(p) { let img=document.createElement('img'); img.src=`https://chessboardjs.com/img/chesspieces/wikipedia/${p.color}${p.type.toUpperCase()}.png`; s.appendChild(img); }
            });
        }
        function handleChess(sq) {
            if(document.querySelector(`[data-n="${sq}"]`).classList.contains('hint')) {
                const mv = { from: selSq, to: sq, promotion: 'q' };
                chess.move(mv); playS('s-move'); renderChess();
                if(cMode==='online') rtdb.ref(`rooms/chess/${cRoom}`).set({m: mv, p: myId, t: Date.now()});
                if(!chess.game_over() && cMode==='ai') setTimeout(masterAI, 600);
                return;
            }
            const p = chess.get(sq);
            if(p && p.color===chess.turn()) {
                selSq=sq; renderChess(); document.querySelector(`[data-n="${sq}"]`).classList.add('sel');
                chess.moves({square:sq, verbose:true}).forEach(m => document.querySelector(`[data-n="${m.to}"]`).classList.add('hint'));
            }
        }
        function masterAI() {
            const moves = chess.moves();
            chess.move(moves[Math.floor(Math.random() * moves.length)]);
            playS('s-move'); renderChess();
        }

        // --- 5. Ø§Ù„Ø¨ØµØ±Ø© (Logic) ---
        let bDeck=[], bTable=[], bP1=[], bP2=[], bS1=0, bS2=0, bTurn=1, bMode='ai', bRoom='';
        function initBasra() { bS1=0; bS2=0; bTurn=1; newB(); }
        function newB() {
            bDeck=[]; ['â™ ','â™£','â™¥','â™¦'].forEach(s => ['A','2','3','4','5','6','7','8','9','10','J','Q','K'].forEach(r => bDeck.push({r,s,c:(s==='â™¥'||s==='â™¦')?'red':'black'})));
            bDeck.sort(()=>Math.random()-0.5); bTable = bDeck.splice(0,4); dealB();
        }
        function dealB() { bP1=bDeck.splice(0,4); bP2=bDeck.splice(0,4); renderB(); }
        function renderB() {
            const tA=document.getElementById('b-table'), p1A=document.getElementById('b-p1'), p2A=document.getElementById('b-p2');
            tA.innerHTML=''; p1A.innerHTML=''; p2A.innerHTML='';
            bTable.forEach(c => tA.appendChild(createC(c, false)));
            bP1.forEach((c,i) => { let el=createC(c,false); if(bTurn===1) el.onclick=()=>playB(i,1); p1A.appendChild(el); });
            bP2.forEach((c,i) => { let el=createC(c, (bMode==='ai'||bTurn===1)); p2A.appendChild(el); });
            document.getElementById('sc1').innerText=bS1; document.getElementById('sc2').innerText=bS2;
        }
        function createC(card, hid) {
            const d=document.createElement('div'); d.className='card-pro'+(hid?' back-c':'')+(card.c==='red'?' red':'');
            d.innerHTML = hid ? '' : `<span>${card.r}</span><span style="font-size:24px">${card.s}</span>`;
            return d;
        }
        function playB(idx, p) {
            playS('s-card'); const hand = p===1?bP1:bP2; const card = hand.splice(idx,1)[0];
            let match = bTable.findIndex(c => c.r===card.r);
            if(card.r==='J') { bS1 += bTable.length + 1; bTable=[]; msg("Ø¨ØµØ±Ø© ÙˆÙ„Ø¯! ğŸ”¥"); }
            else if(match!==-1) { bS1 += 2; bTable.splice(match,1); }
            else bTable.push(card);
            bTurn = p===1?2:1; renderB();
            if(bP1.length===0 && bDeck.length>0) dealB();
            if(bMode==='ai' && bTurn===2) setTimeout(()=>playB(0,2), 1000);
        }
    </script>
</body>
</html>
