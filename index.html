<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoge Chess</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0-beta.6/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://unpkg.com/stockfish@16/src/stockfish.wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background:#121212; color:#fff; font-family:Arial; text-align:center; margin:0; padding:20px; }
        #profile { background:#1e1e1e; padding:20px; margin:20px auto; max-width:500px; border-radius:15px; }
        #points { font-size:3em; color:#77c353; }
        button { background:#77c353; padding:15px 30px; font-size:1.5em; border-radius:12px; margin:15px; cursor:pointer; }
        #board { width:min(95vw,500px); margin:20px auto; }
        #status { font-size:1.8em; margin:20px; }
        #loading { color:#ffeb3b; font-size:1.6em; margin:20px; display:none; }
    </style>
</head>
<body>
    <div id="profile">
        <h2>Ù…Ø±Ø­Ø¨Ø§ ÙŠØ§ <span id="player-name">Ù„Ø§Ø¹Ø¨</span>!</h2>
        <div id="points">0</div>
        <div>ÙÙˆØ²: <span id="wins">0</span> | Ø®Ø³Ø§Ø±Ø©: <span id="losses">0</span> | ØªØ¹Ø§Ø¯Ù„: <span id="draws">0</span></div>
    </div>

    <div id="game-area">
        <h2>Ø´Ø·Ø±Ù†Ø¬ Ø¶Ø¯ AI Ù‚ÙˆÙŠ Ø¬Ø¯Ù‹Ø§</h2>
        <div id="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€AI... (Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø³)</div>
        <div id="board"></div>
        <div id="status">Ø§Ø¶ØºØ· Ø²Ø± Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</div>
        <button onclick="startNewGame('w')">Ø§Ù„Ø¹Ø¨ Ø£Ø¨ÙŠØ¶ (Ø£Ù†Øª ØªØ¨Ø¯Ø£)</button>
        <button onclick="startNewGame('b')">Ø§Ù„Ø¹Ø¨ Ø£Ø³ÙˆØ¯ (AI ÙŠØ¨Ø¯Ø£)</button>
    </div>

    <audio id="move-sound" src="https://assets.mixkit.co/sfx/download/mixkit-chess-piece-move-2107.mp3"></audio>
    <audio id="win-sound" src="https://assets.mixkit.co/sfx/download/mixkit-winning-chimes-2015.mp3"></audio>

    <script>
        const supabaseUrl = 'https://jcgdxtnspmqwunzfkdqa.supabase.co';
        const supabaseKey = 'sb_publishable_yRrI83fceQxrCpug9LOIRg_GZoKR_d4';
        const { createClient } = supabase;
        const supabase = createClient(supabaseUrl, supabaseKey);

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const user = tg.initDataUnsafe?.user || { id: 123456789, first_name: 'Ù„Ø§Ø¹Ø¨' };
        document.getElementById('player-name').textContent = user.first_name || 'Ù„Ø§Ø¹Ø¨';

        let game = new Chess();
        let board;
        let engine;
        let playerColor = 'w';

        async function loadProfile() {
            let { data } = await supabase.from('players').select('*').eq('telegram_id', user.id).single();
            if (!data) {
                const { data: newData } = await supabase.from('players').insert({
                    telegram_id: user.id,
                    first_name: user.first_name,
                    username: user.username || ''
                }).select().single();
                data = newData;
            }
            document.getElementById('points').textContent = data.points || 0;
            document.getElementById('wins').textContent = data.wins || 0;
            document.getElementById('losses').textContent = data.losses || 0;
            document.getElementById('draws').textContent = data.draws || 0;
        }

        async function updateStats(result) {
            let pointsChange = result === 'win' ? 10 : result === 'loss' ? -5 : 2;
            let field = result === 'win' ? 'wins' : result === 'loss' ? 'losses' : 'draws';

            await supabase.from('players').update({
                points: supabase.raw('points + ?', pointsChange),
                [field]: supabase.raw(field + ' + 1')
            }).eq('telegram_id', user.id);

            loadProfile();
        }

        function initEngine() {
            engine = STOCKFISH();
            engine.onmessage = (event) => {
                const line = event.data || event;
                if (line.includes('bestmove')) {
                    const move = line.split(' ')[1];
                    if (move && move !== '(none)') {
                        game.move(move);
                        board.position(game.fen());
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('status').textContent = 'Ø¯ÙˆØ±Ùƒ!';
                        moveSound.play();
                        if (game.game_over()) endGame();
                    }
                }
            };
            engine.postMessage('uci');
            engine.postMessage('setoption name Skill Level value 20');
            engine.postMessage('setoption name Threads value 4');
        }

        function initBoard() {
            if (board) board.destroy();
            board = Chessboard('board', {
                draggable: true,
                position: game.fen(),
                onDrop: (source, target) => {
                    const move = game.move({ from: source, to: target, promotion: 'q' });
                    if (move === null) return 'snapback';
                    moveSound.play();
                    if (game.game_over()) {
                        endGame();
                        return;
                    }
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('status').textContent = 'Ø§Ù„Ù€AI Ø¨ÙŠÙÙƒØ±...';
                    engine.postMessage('position fen ' + game.fen());
                    engine.postMessage('go depth 30');
                }
            });
        }

        function endGame() {
            if (game.in_checkmate()) {
                const result = game.turn() === playerColor ? 'loss' : 'win';
                updateStats(result);
                document.getElementById('status').textContent = result === 'win' ? 'ÙØ²Øª! +10 Ù†Ù‚Ø§Ø· ğŸ‰' : 'Ø®Ø³Ø±Øª! -5 Ù†Ù‚Ø§Ø·';
                winSound.play();
            } else if (game.in_draw()) {
                updateStats('draw');
                document.getElementById('status').textContent = 'ØªØ¹Ø§Ø¯Ù„! +2 Ù†Ù‚Ø§Ø·';
            }
        }

        function startNewGame(color) {
            playerColor = color;
            game = new Chess();
            initBoard();
            document.getElementById('status').textContent = 'Ø¯ÙˆØ±Ùƒ!';
            document.getElementById('loading').style.display = 'none';
            if (color === 'b') {
                document.getElementById('loading').style.display = 'block';
                engine.postMessage('position fen ' + game.fen());
                engine.postMessage('go depth 30');
            }
        }

        const moveSound = document.getElementById('move-sound');
        const winSound = document.getElementById('win-sound');

        // Ø§Ø¨Ø¯Ø£
        initEngine();
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            loadProfile();
        }, 5000); // ÙˆÙ‚Øª ÙƒØ§ÙÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Stockfish
    </script>
</body>
</html>
